### Process firefly transactions
#
# This action expects the github secret `FIREFLY_TRANSACTIONS_SCRIPT` in
# the following format:
# ```json
# {
#   "nc_user": "user",
#   "nc_password": "password",
#   "firefly_users": [{
#     "pat": "eyJ0...",
#     "accounts": { "1": "Credit card", "2": "Cash" },
#     "cospend_payer_username": "user"
#   }, ...]
# }
# ```
# It should conform to the `FIREFLY_TRANSACTIONS_SCRIPT` schema definition in
# `.github/scripts/submit-transactions-to-cospend/src/schema.ts`.
#
# A transaction is expected to have a set of tags starting with `"cospend:"`
# describing metadata about transaction to be added to Cospend.
# All transactions tagged with `"cospend:done"` tag are considered as already
# processed, so they are skipped. Example tags for an incoming transaction:
# ```
# cospend:project:purchases
# cospend:pay-for:user
# cospend:category:Grocery
# cospend:payment-mode:Debit card
# ```
#
# Each transaction is processed by the script in
# `.github/scripts/submit-transactions-to-cospend/`. It expects to receive,
# `nc_base_url`, `nc_user`, and `nc_password` as environment variables with the
# information how to connect and authenticate with nextcloud server. You should
# use username and application password of a user that permissions to create
# transactions in cospend project. The script also expects `input` env var,
# which is a JSON string describing loaded transaction. The `input` object
# should conform to the `TransactionInput` schema defined in
# `.github/scripts/submit-transactions-to-cospend/src/schema.ts`.

on:
  script:
    path: ./.github/scripts/load-unprocessed-transactions.cjs
    secrets: ${{ secrets.FIREFLY_TRANSACTIONS_SCRIPT }}
    deduplicationKey: id
    config:
      force: true
      limit: 10
      filter:
        "transaction.attributes.transactions":
          $elemMatch:
            tags:
              $elemMatch: { $regex: "^cospend:" }
              $nin: ["cospend:done"]

jobs:
  print:
    name: Print
    runs-on: ubuntu-latest
    steps:
      - uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: |
            - cwd: .github/scripts/submit-transactions-to-cospend/
              args: [--frozen-lockfile, --strict-peer-dependencies]
      - name: Process a transaction
        env:
          input: ${{ toJson(on.script.outputs) }}
          nc_user: ${{ fromJSON(secrets.FIREFLY_TRANSACTIONS_SCRIPT).nc_user }}
          nc_password:
            ${{ fromJSON(secrets.FIREFLY_TRANSACTIONS_SCRIPT).nc_password }}
        working-directory: .github/scripts/submit-transactions-to-cospend/
        run: pnpm start
