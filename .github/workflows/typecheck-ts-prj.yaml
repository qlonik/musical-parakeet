---
name: Typecheck TS projects

on:
  pull_request:
    branches: ["main"]
    paths: ["workflows/**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

env:
  PROJECTS: |
    - workflows/process-firefly-transactions/submit-to-cospend

jobs:
  changed-projects:
    name: Changed projects
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changed-projects.outputs.result }}
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed projects
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: workflows/**
          matrix: true

      - name: List all changed files
        run: echo "${{ steps.changed-files.outputs.all_changed_and_modified_files }}"

      - name: Determine changed projects
        id: changed-projects
        uses: actions/github-script@v7
        env:
          PROJECT_PATHS: "${{ env.PROJECTS }}"
          CHANGED_FILES: "${{ steps.changed-files.outputs.all_changed_and_modified_files }}"
        with:
          # language=JS
          script: |
            const result = new Set()

            const changedFiles = JSON.parse(process.env.CHANGED_FILES)

            // console.log('hello world');
            // console.log(context);
            // console.log(...arguments)
            console.log(process.env.CHANGED_FILES)
            console.log(process.env.PROJECTS)
            console.log(process.env.PROJECT_PATHS)
            return true

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    needs: ["changed-projects"]
    strategy:
      matrix:
        paths: ${{ fromJSON(needs.changed-projects.outputs.matrix) }}
      max-parallel: 4
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
