---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: romm
spec:
  values:
    controllers:
      main:
        initContainers:
          minio-init-bucket:
            image:
              repository: ghcr.io/qlonik/minio-init-bucket
              tag: RELEASE.2024-06-24T19-40-33Z@sha256:56f224ebf055de665e97a336b3759555cc5b38846e65ca66bc88f06c0887ed04
            env:
              MINIO_HOST: http://minio.default.svc.cluster.local:9000
              MINIO_SUPER_ACCESS_KEY:
                valueFrom:
                  secretKeyRef:
                    name: minio-secret
                    key: MINIO_ROOT_USER
              MINIO_SUPER_SECRET_KEY:
                valueFrom:
                  secretKeyRef:
                    name: minio-secret
                    key: MINIO_ROOT_PASSWORD
              MINIO_BUCKET_NAME:
                valueFrom:
                  secretKeyRef:
                    name: "{{ .Release.Name }}-restic-secret"
                    key: AWS_ACCESS_KEY_ID
              MINIO_BUCKET_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: "{{ .Release.Name }}-restic-secret"
                    key: AWS_SECRET_ACCESS_KEY
            securityContext:
              runAsUser: 568
              runAsGroup: 568
              runAsNonRoot: true
              fsGroup: 568
              fsGroupChangePolicy: OnRootMismatch
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
