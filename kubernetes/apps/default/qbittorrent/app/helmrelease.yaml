---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: qbittorrent
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 2.2.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  dependsOn:
    - name: minio
      namespace: default
    - name: volsync
      namespace: volsync

  values:
    controllers:
      main:
        type: statefulset

        statefulset:
          volumeClaimTemplates:
            - name: config
              accessMode: ReadWriteMany
              size: 2Gi
              storageClass: nfs-fast
              advancedMounts:
                main:
                  - path: /config

        annotations:
          reloader.stakater.com/auto: "true"
          # configmap.reloader.stakater.com/reload: qbittorrent-scripts,qbittorrent-dnsdist
          # secret.reloader.stakater.com/reload: qbittorrent-secret

        containers:
          main:
            image:
              repository: ghcr.io/onedr0p/qbittorrent
              tag: 4.6.2@sha256:fedb62126c82ae0c7192e9052633411294a27e9c233613c03b0a8d168d160040
            env:
              TZ: ${TIMEZONE}
              UMASK: "022"
              QBITTORRENT__PORT: &port "8080"
              QBT_BitTorrent__Session__Interface: &iface wg0
              QBT_BitTorrent__Session__InterfaceName: *iface
            resources:
              requests:
                cpu: 10m
                memory: 250Mi
              limits:
                memory: 2Gi
            securityContext:
              runAsUser: 568
              runAsGroup: 568

          gluetun:
            image:
              repository: ghcr.io/qdm12/gluetun
              tag: latest@sha256:450a487b23cd460da99b025b32b22fbccd41e7f3a0b083d34326d5a4c88519b0
            env:
              TZ: ${TIMEZONE}
              VPN_SERVICE_PROVIDER: custom
              VPN_TYPE: wireguard
              VPN_INTERFACE: *iface
              VPN_ENDPOINT_PORT: "51820"
              VPN_PORT_FORWARDING: "on"
              VPN_PORT_FORWARDING_PROVIDER: "protonvpn"
              FIREWALL_INPUT_PORTS: *port
              # Allow access to k8s subnets
              FIREWALL_OUTBOUND_SUBNETS: "${CLUSTER_CIDR},${SERVICE_CIDR},${NODE_CIDR}"
              SHADOWSOCKS: "on"
              DOT: "off"
              DNS_ADDRESS: "127.0.0.2"
            envFrom:
              - secretRef:
                  name: qbittorrent-secret
            securityContext:
              capabilities:
                add:
                  - NET_ADMIN

          dnsdist:
            image:
              repository: docker.io/powerdns/dnsdist-18
              tag: 1.8.3@sha256:5f2e92f6363db2bd5bd40319ac2fb10e3a583f6ff5fb5d96a948d9c8b93299b3

          port-forward:
            image:
              repository: docker.io/snoringdragon/gluetun-qbittorrent-port-manager
              tag: 1.3@sha256:679b7a92c494f93b78ad37ef24f3a261e73d0a1a52505ad4f1e39580eedfa14f
            env:
              QBITTORRENT_SERVER: localhost
              QBITTORRENT_PORT: *port
              PORT_FORWARDED: /tmp/gluetun/forwarded_port

        initContainers:
          minio-init-bucket:
            image:
              repository: ghcr.io/qlonik/minio-init-bucket
              tag: RELEASE.2023-04-12T02-21-51Z@sha256:4ce4b3e62f4a1922bbcb9cfbcac529d42ba1702a0914fbdcd79a3bb00425ee2c
            env:
              MINIO_HOST: http://minio.default.svc.cluster.local:9000
              MINIO_SUPER_ACCESS_KEY:
                valueFrom:
                  secretKeyRef:
                    name: minio-secret
                    key: MINIO_ROOT_USER
              MINIO_SUPER_SECRET_KEY:
                valueFrom:
                  secretKeyRef:
                    name: minio-secret
                    key: MINIO_ROOT_PASSWORD
              MINIO_BUCKET_NAME:
                valueFrom:
                  secretKeyRef:
                    name: "qbittorrent-restic-secret"
                    key: AWS_ACCESS_KEY_ID
              MINIO_BUCKET_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: "qbittorrent-restic-secret"
                    key: AWS_SECRET_ACCESS_KEY

        pod:
          podSecurityContext:
            fsGroup: 568
            fsGroupChangePolicy: "OnRootMismatch"
            supplementalGroups: [10000]

    service:
      main:
        ports:
          http:
            port: *port

    ingress:
      main:
        enabled: true
        className: internal
        # annotations:
        #   nginx.ingress.kubernetes.io/configuration-snippet: |
        #     sub_filter '</head>' '<link rel="stylesheet" type="text/css" href="https://theme-park.${SECRET_DOMAIN}/css/base/qbittorrent/nord.css"></head>';
        #     sub_filter_once on;
        hosts:
          - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
            paths:
              - path: "/"
                pathType: Prefix
                service:
                  name: main
                  port: http
        tls:
          - hosts:
              - *host

    persistence:
      downloads:
        enabled: true
        type: nfs
        server: nova.home.arpa
        path: /downloads/qbittorrent
        advancedMounts:
          main:
            main:
              - path: /media/downloads/qbittorrent
      incomplete:
        enabled: true
        type: emptyDir
        advancedMounts:
          main:
            main:
              - path: /incomplete
      scripts:
        type: configMap
        name: qbittorrent-scripts
        defaultMode: 0775
        advancedMounts:
          main:
            main:
              - path: /scripts
                readOnly: true
      dnsdist-config:
        type: configMap
        name: qbittorrent-dnsdist
        advancedMounts:
          main:
            dnsdist:
              - path: /etc/dnsdist/dnsdist.conf
                subPath: dnsdist.conf
                readOnly: true
      gluetun-data:
        type: emptyDir
        advancedMounts:
          main:
            gluetun:
              - path: /tmp/gluetun
            port-forward:
              - path: /tmp/gluetun
                readOnly: true
