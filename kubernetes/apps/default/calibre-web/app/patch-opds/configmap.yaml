---
apiVersion: v1
kind: ConfigMap
metadata:
  name: calibre-web-code-patch
data:
  empty-file: ""
  type: oneshot
  up: "/usr/bin/bash /etc/s6-overlay/s6-rc.d/init-calibre-web-code-patch/run"
  run: |-
    #!/usr/bin/with-contenv bash

    apt-get update -y && apt-get install -y patch
    patch -N -i /etc/s6-overlay/s6-rc.d/init-calibre-web-code-patch/opds.py.patch /app/calibre-web/cps/opds.py
  opds.py.patch: |-
    --- opds.py
    +++ opds.py
    @@ -47,6 +47,9 @@ def requires_basic_auth_if_no_ano(f):
         @wraps(f)
         def decorated(*args, **kwargs):
             auth = request.authorization
    +        user = load_user_from_request(request)
    +        if user:
    +            return f(*args, **kwargs)
             if config.config_anonbrowse != 1:
                 if not auth or auth.type != 'basic' or not check_auth(auth.username, auth.password):
                     return authenticate()
